@page
@using DevApp.Models
@model DevApp.Pages.DeployModel
@{
    ViewData["Title"] = "Deploy";
    Func<string,bool> isUp = h => Model.ServerAccessibility != null && Model.ServerAccessibility.TryGetValue(h, out var ok) && ok;
    
    // Separate servers into online and offline
    var onlineServers = Model.ServerList?.Where(s => isUp(s.HostName)).ToList() ?? new List<ServerInfo>();
    var offlineServers = Model.ServerList?.Where(s => !isUp(s.HostName)).ToList() ?? new List<ServerInfo>();
}

<form id="deploymentForm" method="post" onsubmit="event.preventDefault(); startCopy();" class="my-3">
    @Html.AntiForgeryToken()
    <input type="hidden" id="hubConnectionId" name="HubConnectionId" />
    <h1 class="page-title">Deploy Applications</h1>

    <!-- Top Control Panel - Single Row -->
    <div class="row g-3 mb-3">
        <!-- Environments Selection -->
        <div class="col-lg-3 col-md-4">
            <div class="card shadow-sm border-2 h-100">
                <div class="card-header bg-info text-white">
                    <strong><i class="bi bi-gear"></i> Environments</strong>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex flex-column gap-2">
                        @foreach (var env in Model.Environments)
                        {
                            var isChecked = Model.SelectedEnvironments?.Contains(env.Value, StringComparer.OrdinalIgnoreCase) ?? false;
                            <div class="form-check">
                                <input type="checkbox"
                                       class="form-check-input"
                                       name="SelectedEnvironments"
                                       id="env-@env.Value"
                                       value="@env.Value"
                                       @(isChecked ? "checked" : null) />
                                <label class="form-check-label" for="env-@env.Value">@env.Text</label>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Build -->
        <div class="col-lg-3 col-md-4">
            <div class="card shadow-sm border-2 h-100">
                <div class="card-header bg-info text-white">
                    <strong><i class="bi bi-check-circle"></i> Selected Build</strong>
                </div>
                <div class="card-body p-3">
                    <div id="selectionSummary" class="small" style="max-height:150px; overflow:auto;">
                        <div class="text-muted fst-italic">No build selected</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="col-lg-6 col-md-4">
            <div class="card shadow-sm border-2 h-100">
                <div class="card-header bg-info text-white">
                    <strong><i class="bi bi-rocket"></i> Actions</strong>
                </div>
                <div class="card-body p-3">
                    <div class="d-flex gap-2 mb-3">
                        <button type="submit" class="btn btn-success flex-fill">
                            <i class="bi bi-cloud-arrow-up"></i> Deploy
                        </button>
                        <button type="button" id="clearSelection" class="btn btn-outline-secondary flex-fill">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                    </div>
                    
                    <!-- Progress section -->
                    <div id="progressContainer" class="d-none">
                        <div class="small fw-semibold mb-2">
                            <i class="bi bi-hourglass-split"></i> Deployment Progress
                        </div>
                        <div class="progress mb-2" style="height:24px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%">0%</div>
                        </div>
                        
                        <div id="deploymentLog" class="small bg-success bg-opacity-10 p-2 rounded border border-success border-opacity-25" style="max-height:180px; overflow:auto; min-height:50px; font-family: 'Courier New', monospace; font-size: 0.75rem;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <!-- Servers Card -->
            <div class="card shadow-sm border-2" style="max-height: 65vh; display: flex; flex-direction: column;">
                <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
                    <strong><i class="bi bi-server"></i> Servers</strong>
                    <span class="badge bg-white text-primary">@(Model.ServerList?.Count ?? 0)</span>
                </div>
                <div class="card-body p-2 d-flex flex-column" style="overflow: hidden; flex: 1;">
                    <!-- Search Bar -->
                    <div class="mb-2 flex-shrink-0">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" id="serverSearchInput" class="form-control" placeholder="Search servers...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">Clear</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive" style="overflow-y:auto; flex: 1; min-height: 0;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th scope="col" style="width:40px;">
                                        <div class="form-check">
                                            <input type="checkbox" id="selectAllServers" class="form-check-input" title="Select All">
                                        </div>
                                    </th>
                                    <th scope="col">Host</th>
                                    <th scope="col">Description</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Online Servers Section -->
                                @if (onlineServers.Count > 0)
                                {
                                    <tr class="table-group-header">
                                        <td colspan="4" class="bg-success bg-opacity-10 text-success fw-bold small">
                                            ✓ Online (@onlineServers.Count)
                                        </td>
                                    </tr>
                                    @foreach (var server in onlineServers)
                                    {
                                        <tr class="server-row server-online" data-hostname="@server.HostName" data-description="@server.Description">
                                            <td>
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input server-checkbox"
                                                           name="SelectedServers" value="@server.HostName"
                                                           id="server_@server.HostName" />
                                                </div>
                                            </td>
                                            <td class="fw-semibold small">@server.HostName</td>
                                            <td class="small text-muted">@server.Description</td>
                                            <td>
                                                <span class="badge bg-success">Online</span>
                                            </td>
                                        </tr>
                                    }
                                }

                                <!-- Offline Servers Section -->
                                @if (offlineServers.Count > 0)
                                {
                                    <tr class="table-group-header">
                                        <td colspan="4" class="bg-danger bg-opacity-10 text-danger fw-bold small">
                                            ✗ Offline (@offlineServers.Count)
                                        </td>
                                    </tr>
                                    @foreach (var server in offlineServers)
                                    {
                                        <tr class="server-row server-offline" data-hostname="@server.HostName" data-description="@server.Description">
                                            <td class="text-center">
                                                <i class="bi bi-circle-fill text-danger" style="font-size: 0.6rem;"></i>
                                            </td>
                                            <td class="fw-semibold small text-muted">@server.HostName</td>
                                            <td class="small text-muted">@server.Description</td>
                                            <td>
                                                <span class="badge bg-danger">Offline</span>
                                            </td>
                                        </tr>
                                    }
                                }

                                @if ((onlineServers.Count + offlineServers.Count) == 0)
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted small py-3">No servers configured</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div id="selectedServersInfo" class="small text-muted mt-2 text-center">No servers selected</div>
                </div>
            </div>
        </div>

        <!-- Apps & Builds on the right -->
        <div class="col-lg-8">
            <!-- Apps Container - 3 columns layout -->
            <div class="row g-3" id="appsContainer" style="align-content: flex-start;">
                
                <!-- Admin App Card -->
                @{
                    var adminGroup = Model.AppBuildGroups?.FirstOrDefault(g => g.AppName.Equals("Admin", StringComparison.OrdinalIgnoreCase));
                }
                @if (adminGroup != null)
                {
                    <div class="col-lg-4 col-md-6 col-12">
                        <div class="card shadow-sm border-2" style="height: 65vh; display: flex; flex-direction: column;">
                            <div class="card-header bg-success text-white d-flex align-items-center justify-content-between">
                                <strong><i class="bi bi-shield-check"></i> CST Admin Manager</strong>
                                <span class="badge bg-white text-success">@adminGroup.Variants.Count</span>
                            </div>
                            <div class="card-body p-2" style="overflow:auto; flex: 1;">
                                @if (adminGroup.Variants.Count == 0)
                                {
                                    <div class="small text-muted">No builds available</div>
                                }
                                else
                                {
                                    <div class="list-group list-group-flush">
                                        @foreach (var v in adminGroup.Variants)
                                        {
                                            var checkboxId = $"checkbox_admin_{HashCode.Combine(adminGroup.AppName, v.Build, v.Environment ?? "")}";
                                            <label class="list-group-item list-group-item-action py-2 px-2 d-flex align-items-center build-row-admin"
                                                   for="@checkboxId"
                                                   data-app="@adminGroup.AppName"
                                                   data-build="@v.Build"
                                                   data-env="@v.Environment">
                                                <div class="form-check">
                                                    <input class="form-check-input me-2 build-checkbox"
                                                           type="checkbox"
                                                           id="@checkboxId"
                                                           data-group="admin"
                                                           value="@v.SelectionValue(adminGroup.AppName)"
                                                           data-app="@adminGroup.AppName"
                                                           data-build="@v.Build"
                                                           data-env="@v.Environment" />
                                                </div>
                                                <span class="small">@v.Display</span>
                                            </label>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- TIM App Card -->
                @{
                    var timGroup = Model.AppBuildGroups?.FirstOrDefault(g => g.AppName.Equals("TIM", StringComparison.OrdinalIgnoreCase));
                }
                @if (timGroup != null)
                {
                    <div class="col-lg-4 col-md-6 col-12">
                        <div class="card shadow-sm border-2" style="height: 65vh; display: flex; flex-direction: column;">
                            <div class="card-header bg-success text-white d-flex align-items-center justify-content-between">
                                <strong><i class="bi bi-clock-history"></i> CST TIM</strong>
                                <span class="badge bg-white text-success">@timGroup.Variants.Count</span>
                            </div>
                            <div class="card-body p-2" style="overflow:auto; flex: 1;">
                                @if (timGroup.Variants.Count == 0)
                                {
                                    <div class="small text-muted">No builds available</div>
                                }
                                else
                                {
                                    <div class="list-group list-group-flush">
                                        @foreach (var v in timGroup.Variants)
                                        {
                                            var checkboxId = $"checkbox_tim_{HashCode.Combine(timGroup.AppName, v.Build, v.Environment ?? "")}";
                                            <label class="list-group-item list-group-item-action py-2 px-2 d-flex align-items-center build-row-tim"
                                                   for="@checkboxId"
                                                   data-app="@timGroup.AppName"
                                                   data-build="@v.Build"
                                                   data-env="@v.Environment">
                                                <div class="form-check">
                                                    <input class="form-check-input me-2 build-checkbox"
                                                           type="checkbox"
                                                           id="@checkboxId"
                                                           data-group="tim"
                                                           value="@v.SelectionValue(timGroup.AppName)"
                                                           data-app="@timGroup.AppName"
                                                           data-build="@v.Build"
                                                           data-env="@v.Environment" />
                                                </div>
                                                <span class="small">@v.Display</span>
                                            </label>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- MSIX Packages Card -->
                @if (Model.MSIXBuildGroups != null && Model.MSIXBuildGroups.Count > 0)
                {
                    <div class="col-lg-4 col-md-6 col-12">
                        <div class="card shadow-sm border-2" style="height: 65vh; display: flex; flex-direction: column;">
                            <div class="card-header bg-warning text-dark d-flex align-items-center justify-content-between">
                                <strong><i class="bi bi-box"></i> MSIX Packages (Local Install)</strong>
                                <span class="badge bg-dark text-white">@{
                                    var totalMsixVariants = Model.MSIXBuildGroups?.Sum(g => g.Variants.Count) ?? 0;
                                }@totalMsixVariants</span>
                            </div>
                            <div class="card-body p-2" style="overflow:auto; flex: 1;">
                                @if (Model.MSIXBuildGroups.Count == 0)
                                {
                                    <div class="small text-muted">No builds available</div>
                                }
                                else
                                {
                                    <div class="small text-info mb-2">
                                        <i class="bi bi-info-circle"></i> MSIX packages install locally on this machine only.
                                    </div>
                                    <div class="list-group list-group-flush">
                                        @foreach (var group in Model.MSIXBuildGroups)
                                        {
                                            @foreach (var v in group.Variants)
                                            {
                                                var buttonId = $"msix_install_{HashCode.Combine(group.AppName, v.Build, v.Environment ?? "")}";
                                                <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-2"
                                                     data-app="@group.AppName"
                                                     data-build="@v.Build"
                                                     data-env="@v.Environment">
                                                    <span class="small">@group.AppName - @v.Display</span>
                                                    <button type="button" 
                                                            class="btn btn-sm btn-primary msix-install-btn"
                                                            id="@buttonId"
                                                            data-app="@group.AppName"
                                                            data-build="@v.Build"
                                                            data-env="@v.Environment"
                                                            data-selection="@v.SelectionValue(group.AppName)">
                                                        <i class="bi bi-download"></i> Install
                                                    </button>
                                                </div>
                                            }
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Other Apps Grid (if any remain) -->
                @{
                    var otherApps = Model.AppBuildGroups?
                        .Where(g => !g.AppName.Equals("Admin", StringComparison.OrdinalIgnoreCase) && 
                                    !g.AppName.Equals("TIM", StringComparison.OrdinalIgnoreCase))
                        .ToList() ?? new List<DeployModel.AppBuildGroup>();
                }
                @if (otherApps.Count > 0)
                {
                    @foreach (var group in otherApps)
                    {
                        <div class="col-lg-4 col-md-6 col-12 app-card" data-app="@group.AppName">
                            <div class="card h-100 shadow-sm border-2">
                                <div class="card-header small fw-semibold d-flex justify-content-between align-items-center bg-info text-white">
                                    <strong>@group.AppName</strong>
                                    <span class="badge bg-white text-info">@group.Variants.Count</span>
                                </div>
                                <div class="card-body p-0">
                                    @if (group.Variants.Count == 0)
                                    {
                                        <div class="p-3 text-muted small">No builds available</div>
                                    }
                                    else
                                    {
                                        <div style="max-height: 320px; overflow-y: auto;">
                                            <table class="table table-sm table-hover builds-table mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th scope="col" style="width:50px;"></th>
                                                        <th scope="col">Build</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                @foreach (var v in group.Variants)
                                                {
                                                    var radioId = $"radio_{HashCode.Combine(group.AppName, v.Build, v.Environment ?? "")}";
                                                    <tr class="build-row"
                                                        data-app="@group.AppName"
                                                        data-build="@v.Build"
                                                        data-env="@v.Environment">
                                                        <td>
                                                            <div class="form-check">
                                                                <input class="form-check-input build-radio"
                                                                       type="radio"
                                                                       id="@radioId"
                                                                       name="StandardSelection"
                                                                       value="@v.SelectionValue(group.AppName)"
                                                                       data-app="@group.AppName"
                                                                       data-build="@v.Build"
                                                                       data-env="@v.Environment" />
                                                            </div>
                                                        </td>
                                                        <td class="text-wrap">
                                                            <label class="form-check-label small text-wrap" for="@radioId" title="@v.Display">
                                                                @v.Display
                                                            </label>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</form>

@section Styles {
<style>
    /* Card enhancements */
    .card {
        border: 2px solid rgba(0, 0, 0, 0.125) !important;
        border-radius: 0.5rem;
    }
    
    .card-header {
        font-weight: 600;
        border-bottom: 2px solid rgba(0, 0, 0, 0.125);
        padding: 0.75rem 1rem;
    }
    
    /* Server table enhancements */
    .table-group-header {
        background-color: rgba(0, 0, 0, 0.02);
        border-top: 2px solid rgba(0, 0, 0, 0.05);
    }
    
    .server-row.server-online {
        background-color: rgba(40, 167, 69, 0.03);
    }
    
    .server-row.server-online:hover {
        background-color: rgba(40, 167, 69, 0.08);
    }
    
    .server-row.server-offline {
        opacity: 0.65;
        background-color: rgba(220, 53, 69, 0.03);
    }
    
    .server-row.server-offline:hover {
        opacity: 0.65;
        background-color: rgba(220, 53, 69, 0.08);
        cursor: not-allowed;
    }
    
    .inaccessible-indicator {
        display: inline-block;
        width: 1.2rem;
        text-align: center;
        font-weight: bold;
    }
    
    /* Build row selection highlight */
    .build-row.selected {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .server-row.selected {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .hidden {
        display: none !important;
    }
    
    /* Card header enhancements */
    .card-header {
        font-weight: 500;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }
    
    /* Button group improvements */
    .btn-group .btn {
        border-radius: 0.375rem;
    }
    
    .btn-group .btn:not(:first-child) {
        margin-left: 0.25rem;
    }
    
    /* Selection summary styling */
    #selectionSummary {
        min-height: 40px;
    }
    
    /* Progress container */
    #progressContainer {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
    }
    
    /* Status message box */
    #statusMessage {
        font-size: 0.75rem;
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }
</style>
}

@section Scripts {
<script>
(function(){
    // Prevent toggling inaccessible rows
    document.querySelectorAll('.server-row.server-offline').forEach(row=>{
        row.addEventListener('click', e=>{
            e.preventDefault();
            return false;
        });
    });
    
    const selectAll=document.getElementById('selectAllServers');
    if(selectAll){
        selectAll.addEventListener('change',()=>{
            const checked=selectAll.checked;
            document.querySelectorAll('.server-checkbox').forEach(cb=>{
                cb.checked=checked;
                cb.dispatchEvent(new Event('change'));
            });
        });
    }
})();
</script>

<script>
(function(){
    const serverCheckboxes = document.querySelectorAll('.server-checkbox');
    const selectAllServers = document.getElementById('selectAllServers');
    const selectedServersInfo = document.getElementById('selectedServersInfo');
    const selectionSummary = document.getElementById('selectionSummary');
    const clearSelectionBtn = document.getElementById('clearSelection');
    const progressContainer = document.getElementById('progressContainer');
    const deployBtn = document.querySelector('button[type="submit"]');
    // const openRootBtn = document.getElementById('openRootBtn');

    let selectedServers = [];

    document.querySelectorAll('.server-row.server-online').forEach(row => {
        row.addEventListener('click', e => {
            if (e.target.type === 'checkbox') return;
            const cb = row.querySelector('.server-checkbox');
            if (cb) {
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event('change'));
            }
        });
    });

    function updateServerRowStyles(){
        serverCheckboxes.forEach(cb=>{
            const row = cb.closest('.server-row');
            row?.classList.toggle('selected', cb.checked);
        });
    }
    
    function updateSelectAllState(){
        const total = serverCheckboxes.length;
        const checked = Array.from(serverCheckboxes).filter(c=>c.checked).length;
        if (checked === 0){ selectAllServers.indeterminate=false; selectAllServers.checked=false; }
        else if (checked === total){ selectAllServers.indeterminate=false; selectAllServers.checked=true; }
        else { selectAllServers.indeterminate=true; selectAllServers.checked=false; }
    }
    
    function updateSelectedServersInfo(){
        selectedServers = Array.from(serverCheckboxes).filter(c=>c.checked).map(c=>c.value);
        if (selectedServers.length === 0) selectedServersInfo.textContent = 'No servers selected';
        else if (selectedServers.length === 1) selectedServersInfo.textContent = `✓ Selected: ${selectedServers[0]}`;
        else selectedServersInfo.textContent = `✓ Selected: ${selectedServers.length} servers`;
    }

    selectAllServers.addEventListener('change', ()=>{
        serverCheckboxes.forEach(c=>c.checked=selectAllServers.checked);
        updateServerRowStyles();
        updateSelectAllState();
        updateSelectedServersInfo();
    });
    
    serverCheckboxes.forEach(c=>c.addEventListener('change', ()=>{
        updateServerRowStyles();
        updateSelectAllState();
        updateSelectedServersInfo();
    }));
    
    updateServerRowStyles(); 
    updateSelectAllState(); 
    updateSelectedServersInfo();

    function filterMSIXBuilds() {
        const selectedEnvs = Array.from(document.querySelectorAll('input[name="SelectedEnvironments"]:checked')).map(e => e.value);
        let shownCount = 0;
        
        document.querySelectorAll('.build-row-msix').forEach(row => {
            const rowEnv = row.dataset.env;
            const shouldShow = selectedEnvs.length > 0 && selectedEnvs.some(env => env.toLowerCase() === rowEnv?.toLowerCase());
            
            if (shouldShow) {
                row.style.display = 'flex';
                row.classList.remove('d-none');
                shownCount++;
            } else {
                row.style.display = 'none';
                row.classList.add('d-none');
                const radio = row.querySelector('.msix-radio');
                if (radio && radio.checked) {
                    radio.checked = false;
                }
            }
        });
        
        const msixCard = document.querySelector('.card-header.bg-success')?.closest('.card');
        if (msixCard && shownCount === 0) {
            msixCard.style.display = 'none';
        } else if (msixCard) {
            msixCard.style.display = '';
        }
        
        refreshSelectionSummary();
    }

    document.querySelectorAll('input[name="SelectedEnvironments"]').forEach(envBtn => {
        envBtn.addEventListener('change', filterMSIXBuilds);
    });

    const buildRadios = document.querySelectorAll('.build-radio');
    const buildCheckboxes = document.querySelectorAll('.build-checkbox');

    function updateBuildRowStyles() {
        document.querySelectorAll('.build-checkbox').forEach(cb => {
            const row = cb.closest('.list-group-item');
            row?.classList.toggle('selected', cb.checked);
        });
    }
    
    function refreshSelectionSummary(){
        const checkedStandard = document.querySelectorAll('.build-checkbox:checked');
        
        selectionSummary.innerHTML='';
        
        if (checkedStandard.length > 0) {
            checkedStandard.forEach(cb => {
                const div=document.createElement('div');
                div.className = 'mb-1 p-2 bg-light rounded';
                const env = cb.dataset.env ? ` <span class="badge bg-secondary">${cb.dataset.env}</span>` : '';
                div.innerHTML = `<strong>${cb.dataset.app}</strong> :: ${cb.dataset.build}${env}`;
                selectionSummary.appendChild(div);
            });
        } else {
            selectionSummary.innerHTML = '<div class="text-muted fst-italic">No build selected</div>';
        }
    }

    buildCheckboxes.forEach(cb=>{
        cb.addEventListener('change', ()=>{
            updateBuildRowStyles();
            refreshSelectionSummary();
        });
    });

    clearSelectionBtn.addEventListener('click', ()=>{
        document.querySelectorAll('.build-checkbox').forEach(cb=>cb.checked=false);
        updateBuildRowStyles();
        refreshSelectionSummary();
    });

    // Server search functionality
    const serverSearchInput = document.getElementById('serverSearchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    function filterServers() {
        const searchTerm = serverSearchInput.value.toLowerCase().trim();
        const serverRows = document.querySelectorAll('.server-row');

        serverRows.forEach(row => {
            const hostname = row.getAttribute('data-hostname').toLowerCase();
            const description = (row.getAttribute('data-description') || '').toLowerCase();
            
            if (searchTerm === '' || hostname.includes(searchTerm) || description.includes(searchTerm)) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        });
    }

    serverSearchInput.addEventListener('input', filterServers);
    clearSearchBtn.addEventListener('click', () => {
        serverSearchInput.value = '';
        filterServers();
    });

    // MSIX install button handlers
    document.querySelectorAll('.msix-install-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const app = this.dataset.app;
            const build = this.dataset.build;
            const env = this.dataset.env || '';
            
            // Open install page in new window
            window.open(`/DevApp/Install?app=${encodeURIComponent(app)}&build=${encodeURIComponent(build)}&env=${encodeURIComponent(env)}`, '_blank');
        });
    });

    // Update startCopy to handle multiple checkbox selections
    window.startCopy = function(){
        console.log('startCopy called');
        const checkedStandard = Array.from(document.querySelectorAll('.build-checkbox:checked'));
        
        console.log('Checked standard:', checkedStandard);
        
        const servers = Array.from(serverCheckboxes).filter(c=>c.checked).map(c=>c.value);
        
        console.log('Selected servers:', servers);
        console.log('Hub connection ID:', document.getElementById('hubConnectionId').value);
        
        if(!servers.length){ 
            alert('Select at least one server.'); 
            return; 
        }
        if(checkedStandard.length === 0){ 
            alert('Select at least one build to deploy.'); 
            return; 
        }

        console.log('Starting deployment...');
        progressContainer.classList.remove('d-none');
        deploymentLog.innerHTML = '';
        deployBtn.disabled = true;

        const form = document.getElementById('deploymentForm');
        const fd = new FormData(form);
        
        fd.set('HubConnectionId', document.getElementById('hubConnectionId').value);
        fd.delete('Selections');
        
        // Add all checked builds to selections
        checkedStandard.forEach(cb => {
            fd.append('Selections', cb.value);
        });

        const token = fd.get('__RequestVerificationToken');
        const body = new URLSearchParams(fd).toString();

        console.log('Sending fetch request to /DevApp/Deploy?handler=Copy');
        console.log('Body:', body);

        fetch('/DevApp/Deploy?handler=Copy', {
            method:'POST',
            headers:{
                'Content-Type':'application/x-www-form-urlencoded',
                'RequestVerificationToken': token
            },
            body
        }).then(async r=>{
            console.log('Fetch response received:', r.status, r.statusText);
            const responseText = await r.text();
            console.log('Response text:', responseText);
            let payload;
            try { 
                payload = JSON.parse(responseText); 
                console.log('Parsed payload:', payload);
                
                // Show success message
                if (payload && payload.success) {
                    const log = document.getElementById('deploymentLog');
                    log.innerHTML = ''; // Clear any previous content
                    const successMsg = document.createElement('div');
                    successMsg.className = 'text-success fw-bold';
                    successMsg.textContent = `✓ Deployment initiated successfully! ${payload.copyTasks} copy task(s) and ${payload.shortcutTasks} shortcut task(s) queued.`;
                    log.appendChild(successMsg);
                    
                    const hr = document.createElement('hr');
                    hr.className = 'my-2';
                    log.appendChild(hr);
                } else {
                    const log = document.getElementById('deploymentLog');
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'text-danger fw-bold';
                    errorMsg.textContent = '✗ Deployment failed or returned unexpected response.';
                    log.appendChild(errorMsg);
                }
            } catch(e) { 
                console.error('JSON parse error:', e);
                payload = null; 
            }
        }).catch(err=>{
            console.error('Fetch error:', err);
            const log = document.getElementById('deploymentLog');
            const errorMsg = document.createElement('div');
            errorMsg.className = 'text-danger fw-bold';
            errorMsg.textContent = '✗ Network error: ' + err.message;
            log.appendChild(errorMsg);
        }).finally(()=>{
            setTimeout(() => {
                deployBtn.disabled = false;
            }, 5000); // Re-enable after 5 seconds
        });
    };

})();
</script>

<script>
// SignalR Hub Connection Setup
(async function() {
    const conn = new signalR.HubConnectionBuilder()
        .withUrl("/DevApp/copyHub")
        .withAutomaticReconnect()
        .build();

    // Listen for progress updates from server
    conn.on("ReceiveProgress", (pct) => {
        console.log('ReceiveProgress:', pct);
        const pb = document.getElementById('progressBar');
        if (pb) {
            pb.style.width = pct + '%';
            pb.textContent = pct + '%';
        }
    });

    // Listen for log messages from server
    conn.on("ReceiveMessage", (msg) => {
        console.log('ReceiveMessage:', msg);
        const log = document.getElementById('deploymentLog');
        if (log) {
            try {
                const data = JSON.parse(msg);
                const div = document.createElement('div');
                div.className = 'mb-1';
                
                // Format based on message type
                if (data.type === 'copy_started') {
                    div.innerHTML = `<strong>📦 Starting:</strong> ${data.app} ${data.build} → ${data.server} (${data.totalFiles} files)`;
                } else if (data.type === 'copy_completed') {
                    div.innerHTML = `<strong class="text-success">✓ Copy Complete:</strong> ${data.app} ${data.build} → ${data.server} (${data.filesCopied} files)`;
                } else if (data.type === 'deployment_complete') {
                    div.innerHTML = `<strong class="text-info">🔗 Shortcut Created:</strong> ${data.shortcutName} on ${data.server} (${data.environment})`;
                } else if (data.Message) {
                    div.textContent = data.Message;
                } else {
                    // Display readable JSON for debugging
                    div.innerHTML = `<pre class="mb-0 small">${JSON.stringify(data, null, 2)}</pre>`;
                }
                
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            } catch (e) {
                // Not JSON, display as plain text
                const div = document.createElement('div');
                div.textContent = msg;
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            }
        }
    });

    // Listen for error messages from server
    conn.on("ReceiveError", (msg) => {
        console.log('ReceiveError:', msg);
        const log = document.getElementById('deploymentLog');
        if (log) {
            const div = document.createElement('div');
            div.className = 'text-danger';
            div.textContent = msg;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }
    });

    try {
        await conn.start();
        document.getElementById('hubConnectionId').value = conn.connectionId;
        console.log("SignalR connected:", conn.connectionId);
    } catch (err) {
        console.error("SignalR connection failed:", err);
    }
})();
</script>
}
