@page
@model ApplicationDeployment.Pages.DeployModel
@using System.Text.Json

<form id="deploymentForm" method="post" onsubmit="event.preventDefault(); startCopy();" class="container my-4">
    @Html.AntiForgeryToken()
    <input type="hidden" id="hubConnectionId" name="HubConnectionId" />
    <h1 class="display-5 text-primary mb-4">Application Deployment</h1>

    <div class="row g-4">
        <!-- LEFT: Servers + Env Filters -->
        <div class="col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light fw-semibold">Destination Servers</div>
                <div class="card-body d-flex flex-column">
                    <label class="form-label small">Servers</label>
                    <div class="table-responsive" style="max-height:300px; overflow:auto;">
                        <table class="table table-sm table-hover mb-2">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th scope="col">
                                        <input type="checkbox" id="selectAllServers" class="form-check-input" title="Select All">
                                    </th>
                                    <th scope="col">Host</th>
                                    <th scope="col">User</th>
                                    <th scope="col">Description</th>
                                </tr>
                            </thead>
                            <tbody id="serversTableBody">
                                @foreach (var server in Model.ServerList)
                                {
                                    <tr class="server-row" data-hostname="@server.HostName">
                                        <td>
                                            <input type="checkbox" class="form-check-input server-checkbox" 
                                                   name="SelectedServers" value="@server.HostName" 
                                                   id="server_@server.HostName">
                                        </td>
                                        <td class="fw-semibold">@server.HostName</td>
                                        <td class="small text-muted">@server.UserID</td>
                                        <td class="small">@server.Description</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div id="serverChips" class="mb-2 d-flex flex-wrap gap-2 small"></div>

                    <label class="form-label small mt-2">Environment Filter</label>
                    <div id="envFilters" class="btn-group btn-group-sm mb-2" role="group">
                        @foreach (var env in new[] { "DEV","QA","UAT","REG" })
                        {
                            <button type="button" class="btn btn-outline-secondary env-btn" data-env="@env">@env</button>
                        }
                    </div>

                    <div class="mt-auto small text-muted">
                        Use filters to limit visible builds in center column.
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER: Apps as separate cards with scrollable multiselect build lists -->
        <div class="col-lg-6">
            <div class="row row-cols-1 row-cols-md-2 g-3" id="appsCardsContainer" style="max-height:72vh; overflow:auto;">
                @if (Model.AppBuildGroups == null || Model.AppBuildGroups.Count == 0)
                {
                    <div class="col">
                        <div class="alert alert-warning m-0">No applications found.</div>
                    </div>
                }
                else
                {
                    foreach (var group in Model.AppBuildGroups.OrderBy(g => g.AppName))
                    {
                        var safeApp = Html.Raw(group.AppName);
                        <div class="col">
                            <div class="card h-100 shadow-sm app-card" data-app="@group.AppName">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div class="fw-semibold text-truncate" style="max-width:80%;">@group.AppName</div>
                                    <span class="badge bg-secondary small app-badge" data-app-badge="@group.AppName">@group.Builds.Count</span>
                                </div>
                                <div class="card-body p-2">
                                    @if (group.Builds.Count == 0)
                                    {
                                        <div class="text-muted small">No builds</div>
                                    }
                                    else
                                    {
                                        <div class="form-check" style="max-height:220px; overflow:auto;">
                                            @foreach (var build in group.Builds)
                                            {
                                                var value = $"{group.AppName}|{build}";
                                                <div class="form-check">
                                                    <input class="form-check-input build-checkbox" type="checkbox"
                                                           id="@($"chk_{HashCode.Combine(group.AppName, build)}")"
                                                           name="Selections" value="@value" data-app="@group.AppName" data-build="@build" />
                                                    <label class="form-check-label small text-wrap" for="@($"chk_{HashCode.Combine(group.AppName, build)}")" title="@build">
                                                        @build
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- RIGHT: Actions and Progress -->
        <div class="col-lg-3">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light fw-semibold">Actions</div>
                <div class="card-body d-flex flex-column">
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary w-100 mb-2">Deploy Selected</button>
                        <button type="button" id="clearSelection" class="btn btn-outline-secondary w-100">Clear Selection</button>
                    </div>

                    <div class="small mb-2"><strong>Selected Builds</strong></div>
                    <div id="selectionSummary" class="small mb-3" style="max-height:120px; overflow:auto;">(none)</div>

                    <div id="progressContainer" class="d-none mt-auto">
                        <div class="small text-muted mb-1">Progress</div>
                        <div class="progress mb-2" style="height:20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%">0%</div>
                        </div>
                        <pre id="statusMessage" class="small bg-light p-2 rounded" style="height:160px; overflow:auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

@section Scripts {
<style>
    .app-card { min-height: 220px; }
    .app-card .card-body { padding: 0.5rem; }
    .form-check-label { white-space: normal; }
    .env-btn.active { background:#0d6efd; color:#fff; border-color:#0d6efd; }
    .build-checkbox:checked + label { font-weight:600; color:#0d6efd; }
    .server-row:hover { background-color: rgba(0,123,255,0.1); }
    .server-row.selected { background-color: rgba(0,123,255,0.2); }
    .sticky-top { position: sticky; top: 0; z-index: 10; }
</style>

<script>
(function(){
    // Helpers
    const serverCheckboxes = document.querySelectorAll('.server-checkbox');
    const selectAllServers = document.getElementById('selectAllServers');
    const serverChips = document.getElementById('serverChips');
    const selectionSummary = document.getElementById('selectionSummary');
    const clearSelectionBtn = document.getElementById('clearSelection');
    const progressContainer = document.getElementById('progressContainer');

    // Server row selection (full row click)
    document.querySelectorAll('.server-row').forEach(row => {
        row.addEventListener('click', (e) => {
            if (e.target.type === 'checkbox') return; // Don't interfere with checkbox clicks
            
            const checkbox = row.querySelector('.server-checkbox');
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
        });
    });

    // Server checkbox handling
    function updateServerRowStyles() {
        serverCheckboxes.forEach(cb => {
            const row = cb.closest('.server-row');
            if (cb.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    }

    function updateSelectAllState() {
        const totalCheckboxes = serverCheckboxes.length;
        const checkedCheckboxes = Array.from(serverCheckboxes).filter(cb => cb.checked).length;
        
        if (checkedCheckboxes === 0) {
            selectAllServers.indeterminate = false;
            selectAllServers.checked = false;
        } else if (checkedCheckboxes === totalCheckboxes) {
            selectAllServers.indeterminate = false;
            selectAllServers.checked = true;
        } else {
            selectAllServers.indeterminate = true;
            selectAllServers.checked = false;
        }
    }

    // Select all functionality
    selectAllServers.addEventListener('change', () => {
        const checked = selectAllServers.checked;
        serverCheckboxes.forEach(cb => {
            cb.checked = checked;
        });
        updateServerRowStyles();
        refreshServerChips();
    });

    // Individual checkbox change handlers
    serverCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
            updateServerRowStyles();
            updateSelectAllState();
            refreshServerChips();
        });
    });

    // Server chips
    function refreshServerChips(){
        serverChips.innerHTML = '';
        Array.from(serverCheckboxes).filter(cb => cb.checked).forEach(cb => {
            const span = document.createElement('span');
            span.className = 'badge rounded-pill bg-primary';
            span.textContent = cb.value;
            serverChips.appendChild(span);
        });
    }

    // Initialize server states
    updateServerRowStyles();
    updateSelectAllState();
    refreshServerChips();

    // Build selection summary
    function refreshSelectionSummary(){
        const checks = Array.from(document.querySelectorAll('.build-checkbox')).filter(c=>c.checked);
        if(checks.length === 0){
            selectionSummary.textContent = '(none)';
            return;
        }
        selectionSummary.innerHTML = '';
        checks.forEach(c=>{
            const app = c.dataset.app;
            const build = c.dataset.build;
            const div = document.createElement('div');
            div.textContent = app + ' :: ' + build;
            selectionSummary.appendChild(div);
        });
    }

    document.querySelectorAll('.build-checkbox').forEach(cb=>{
        cb.addEventListener('change', ()=> {
            refreshSelectionSummary();
        });
    });

    clearSelectionBtn.addEventListener('click', ()=>{
        document.querySelectorAll('.build-checkbox').forEach(cb=>{
            cb.checked = false;
        });
        refreshSelectionSummary();
    });

    // Env filter
    const envButtons = document.querySelectorAll('.env-btn');
    function activeEnvFilters(){ return Array.from(envButtons).filter(b=>b.classList.contains('active')).map(b=>b.dataset.env); }
    function envMatches(buildName, envs){
        if(envs.length===0) return true;
        return envs.some(env => new RegExp(`(^|[^A-Z0-9])${env}([^A-Z0-9]|$)`, 'i').test(buildName));
    }
    function applyEnvFilter(){
        const envs = activeEnvFilters();
        document.querySelectorAll('.build-checkbox').forEach(cb=>{
            const build = cb.dataset.build || '';
            cb.parentElement.style.display = envMatches(build, envs) ? '' : 'none';
            if(cb.parentElement.style.display === 'none') cb.checked = false;
        });
        refreshSelectionSummary();
    }
    envButtons.forEach(b=> b.addEventListener('click', ()=> { b.classList.toggle('active'); applyEnvFilter(); }));
    document.getElementById('clearEnvFilters')?.addEventListener('click', ()=> {
        envButtons.forEach(b=>b.classList.remove('active'));
        applyEnvFilter();
    });

    // SignalR
    const connection = new signalR.HubConnectionBuilder().withUrl("/copyHub").build();
    connection.on("ReceiveProgress", p => {
        const bar = document.getElementById("progressBar");
        bar.style.width = p + "%";
        bar.textContent = p + "%";
    });
    connection.on("ReceiveMessage", m => {
        const box = document.getElementById("statusMessage");
        box.textContent += m + "\n";
        box.scrollTop = box.scrollHeight;
    });
    connection.start().then(()=> {
        document.getElementById('hubConnectionId').value = connection.connectionId;
    }).catch(err=>console.error("SignalR connection error:", err));

    // Deploy
    window.startCopy = function(){
        const servers = Array.from(serverCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        const selections = Array.from(document.querySelectorAll('.build-checkbox')).filter(c=>c.checked).map(c=>c.value);
        const hubId = document.getElementById('hubConnectionId').value;

        if(servers.length === 0){ alert('Select at least one server.'); return; }
        if(selections.length === 0){ alert('Select at least one build.'); return; }

        progressContainer.classList.remove('d-none');

        // Build form body
        const form = document.getElementById('deploymentForm');
        const fd = new FormData(form);

        // Hub id
        fd.set('HubConnectionId', hubId);

        const token = fd.get('__RequestVerificationToken');
        const body = new URLSearchParams(fd).toString();

        fetch('/Deploy?handler=Copy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': token
            },
            body
        }).then(r=> {
            if(!r.ok) return r.text().then(t=>{ console.error('Server error', r.status, t); throw new Error('Server error'); });
            return r.json();
        }).then(obj=>{
            if(!obj.success) alert(obj.message || 'Failed');
        }).catch(err=>{ console.error('Copy start error:', err); });
    };

})();
</script>
}
