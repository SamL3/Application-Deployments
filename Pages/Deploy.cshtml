@page
@model DevApp.Pages.DeployModel
@{
    ViewData["Title"] = "Deploy";
    // Move this block ABOVE any usage of isUp
    Func<string,bool> isUp = h => Model.ServerAccessibility != null && Model.ServerAccessibility.TryGetValue(h, out var ok) && ok;
}

<form id="deploymentForm" method="post" onsubmit="event.preventDefault(); startCopy();" class="my-3">
    @Html.AntiForgeryToken()
    <input type="hidden" id="hubConnectionId" name="HubConnectionId" />
    <h1 class="page-title">Deploy Applications</h1>

    <div class="row g-4">
        <div class="col-lg-4">
            <!-- Servers + Actions (unchanged) -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">Servers</div>
                <div class="card-body p-2 d-flex flex-column">
                    <div class="table-responsive" style="max-height:320px; overflow:auto;">
                        <table class="table table-sm table-hover mb-2">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th scope="col">
                                        <input type="checkbox" id="selectAllServers" class="form-check-input" title="Select All">
                                    </th>
                                    <th scope="col">Host</th>
                                    <th scope="col">User</th>
                                    <th scope="col">Description</th>
                                </tr>
                            </thead>
                            <tbody id="serversTableBody">
                                @foreach (var server in Model.ServerList)
                                {
                                    var accessible = isUp(server.HostName);
                                    <tr class="server-row @(accessible ? "" : "server-down")" data-hostname="@server.HostName">
                                        <td>
                                            @if (accessible)
                                            {
                                                <input type="checkbox" class="form-check-input server-checkbox"
                                                       name="SelectedServers" value="@server.HostName"
                                                       id="server_@server.HostName" />
                                            }
                                            else
                                            {
                                                <span class="inaccessible-indicator text-danger fw-bold">X</span>
                                            }
                                        </td>
                                        <td class="fw-semibold">@server.HostName</td>
                                        <td class="small text-muted">@server.UserID</td>
                                        <td class="small">
                                            @server.Description
                                            @if (!accessible)
                                            {
                                                <span class="badge bg-danger ms-1">Down</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div id="selectedServersInfo" class="small text-muted mt-2">No servers selected</div>

                    <!-- Replace the environment dropdown with a multi-select button group -->
                    <div class="mb-3">
                      <label class="form-label">Environments</label>
                      <div class="btn-group flex-wrap" role="group" aria-label="Environments">
                        @foreach (var env in Model.Environments)
                        {
                            var isChecked = Model.SelectedEnvironments?.Contains(env.Value, StringComparer.OrdinalIgnoreCase) ?? false;
                            <input type="checkbox"
                                   class="btn-check"
                                   name="SelectedEnvironments"
                                   id="env-@env.Value"
                                   value="@env.Value"
                                   @(isChecked ? "checked" : null)
                                   autocomplete="off" />
                            <label class="btn btn-outline-primary m-1" for="env-@env.Value">@env.Text</label>
                        }
                      </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">Actions</div>
                <div class="card-body d-flex flex-column">
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary w-100 mb-2">Deploy Selected</button>
                        <button type="button" id="clearSelection" class="btn btn-outline-secondary w-100 mb-2">Clear Selection</button>
                        <button type="button" id="openRootBtn" class="btn btn-outline-info w-100 mb-2"
                                data-path="@Model.StagingPath">Open Root App Folder</button>
                        <button type="button" id="openShortcutsBtn" class="btn btn-outline-success w-100"
                                title="Open C:\CSTApps folder">Open Shortcuts Folder</button>
                    </div>

                    <div class="small mb-2"><strong>Selected Builds</strong></div>
                    <div id="selectionSummary" class="small mb-3" style="max-height:120px; overflow:auto;">(none)</div>

                    <div id="progressContainer" class="d-none">
                        <div class="small text-muted mb-1">Progress</div>
                        <div class="progress mb-2" style="height:20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%">0%</div>
                        </div>
                        <pre id="statusMessage" class="small bg-light p-2 rounded" style="height:160px; overflow:auto;"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Apps grid on the right, rendered similar to Remove -->
        <div class="col-lg-8">
            <!-- MSIX Packages Card (WinMobile) -->
            @if (Model.MSIXBuildGroups != null && Model.MSIXBuildGroups.Count > 0)
            {
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-success text-white">
                        <strong>MSIX Packages (WinMobile)</strong>
                    </div>
                    <div class="card-body p-2" style="max-height:30vh; overflow:auto;">
                        <div class="row row-cols-1 g-2">
                            @foreach (var group in Model.MSIXBuildGroups)
                            {
                                <div class="col">
                                    <div class="card">
                                        <div class="card-header small fw-semibold d-flex justify-content-between align-items-center py-1">
                                            <span>@group.AppName</span>
                                            <span class="badge bg-secondary">@group.Variants.Count</span>
                                        </div>
                                        <div class="card-body p-2">
                                            @if (group.Variants.Count == 0)
                                            {
                                                <div class="small text-muted">No builds</div>
                                            }
                                            else
                                            {
                                                <div class="list-group list-group-flush msix-builds-list" style="max-height: 320px; overflow-y: auto;">
                                                    @foreach (var v in group.Variants)
                                                    {
                                                        var radioId = $"radio_msix_{HashCode.Combine(group.AppName, v.Build, v.Environment ?? "")}";
                                                        <label class="list-group-item list-group-item-action py-2 px-3 d-flex align-items-center build-row-msix" 
                                                               for="@radioId"
                                                               data-app="@group.AppName"
                                                               data-build="@v.Build"
                                                               data-env="@v.Environment">
                                                            <input class="form-check-input me-2 msix-radio"
                                                                   type="radio"
                                                                   id="@radioId"
                                                                   name="MSIXSelection"
                                                                   value="@v.SelectionValue(group.AppName)"
                                                                   data-app="@group.AppName"
                                                                   data-build="@v.Build"
                                                                   data-env="@v.Environment" />
                                                            <span class="small">@v.Display</span>
                                                        </label>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Standard Apps Grid -->
            <div class="row row-cols-1 row-cols-md-2 g-3" id="appsCardsContainer" style="max-height:72vh; overflow:auto;">
                @if (Model.AppBuildGroups == null || Model.AppBuildGroups.Count == 0)
                {
                    <div class="col">
                        <div class="alert alert-warning m-0">No applications found.</div>
                    </div>
                }
                else
                {
                    foreach (var group in Model.AppBuildGroups)
                    {
                        <div class="col app-card" data-app="@group.AppName">
                            <div class="card h-100 shadow-sm">
                                <div class="card-header small fw-semibold d-flex justify-content-between align-items-center">
                                    <span>@group.AppName</span>
                                    <span class="badge bg-secondary app-badge" data-app-badge="@group.AppName">@group.Variants.Count</span>
                                </div>
                                <div class="card-body p-0">
                                    @if (group.Variants.Count == 0)
                                    {
                                        <div class="p-3 text-muted small">No builds</div>
                                    }
                                    else
                                    {
                                        <div style="max-height: 320px; overflow-y: auto;">
                                            <table class="table table-sm table-hover builds-table mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th scope="col" style="width:50px;"></th>
                                                        <th scope="col">Build</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                @foreach (var v in group.Variants)
                                                {
                                                    var radioId = $"radio_{HashCode.Combine(group.AppName, v.Build, v.Environment ?? "")}";
                                                    <tr class="build-row"
                                                        data-app="@group.AppName"
                                                        data-build="@v.Build"
                                                        data-env="@v.Environment">
                                                        <td>
                                                            <input class="form-check-input build-radio"
                                                                   type="radio"
                                                                   id="@radioId"
                                                                   name="StandardSelection"
                                                                   value="@v.SelectionValue(group.AppName)"
                                                                   data-app="@group.AppName"
                                                                   data-build="@v.Build"
                                                                   data-env="@v.Environment" />
                                                        </td>
                                                        <td class="text-wrap">
                                                            <label class="form-check-label small text-wrap" for="@radioId" title="@v.Display">
                                                                @v.Display
                                                            </label>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</form>

@section Scripts {
<script>
(function(){
    // Patch existing logic: prevent toggling inaccessible rows
    document.querySelectorAll('.server-row').forEach(row=>{
        row.addEventListener('click', e=>{
            const cb=row.querySelector('.server-checkbox');
            if(!cb || cb.disabled) return;
            if(e.target.type==='checkbox') return;
            cb.checked=!cb.checked;
            cb.dispatchEvent(new Event('change'));
        });
    });
    const selectAll=document.getElementById('selectAllServers');
    if(selectAll){
        selectAll.addEventListener('change',()=>{
            const checked=selectAll.checked;
            document.querySelectorAll('.server-checkbox').forEach(cb=>{
                if(cb.disabled) return;
                cb.checked=checked;
                cb.dispatchEvent(new Event('change'));
            });
        });
    }
})();
</script>
<style>
    .inaccessible-indicator { display:inline-block; width:1.1rem; text-align:center; }
    .server-row.server-down { opacity:.55; }
    .server-row.server-down:hover { background:inherit; cursor:not-allowed; }
</style>

<script>
(function(){
    const serverCheckboxes = document.querySelectorAll('.server-checkbox');
    const selectAllServers = document.getElementById('selectAllServers');
    const selectedServersInfo = document.getElementById('selectedServersInfo');
    const selectionSummary = document.getElementById('selectionSummary');
    const clearSelectionBtn = document.getElementById('clearSelection');
    const progressContainer = document.getElementById('progressContainer');
    const envSelect = document.getElementById('envSelect');
    const deployBtn = document.querySelector('button[type="submit"]');
    const statusBox = document.getElementById('statusMessage');
    const openRootBtn = document.getElementById('openRootBtn');

    let selectedServers = [];

    if (openRootBtn) {
        openRootBtn.addEventListener('click', function(e){
            e.preventDefault();
            const p = this.dataset.path || '';
            if (!p) { alert('Root App folder (StagingPath) not configured.'); return; }
            
            // For UNC paths, show in prompt for easy copying
            let url = p;
            if (url.startsWith('\\\\')) {
                // Use prompt which allows easy copy (Ctrl+C)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(url).then(() => {
                        alert('Network path copied to clipboard:\n' + url + '\n\nPaste into Windows Explorer address bar (Win+E, Ctrl+V)');
                    }).catch(() => {
                        prompt('Copy this path (Ctrl+C) to open in Windows Explorer:', url);
                    });
                } else {
                    prompt('Copy this path (Ctrl+C) to open in Windows Explorer:', url);
                }
            } else {
                // Local paths might work with file:/// protocol
                url = 'file:///' + url.replace(/\\/g, '/');
                const w = window.open(url, '_blank');
                if (!w) {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(p).then(() => {
                            alert('Path copied to clipboard:\n' + p + '\n\nPaste into Windows Explorer (Win+E, Ctrl+V)');
                        }).catch(() => {
                            prompt('Copy this path (Ctrl+C) to open in Windows Explorer:', p);
                        });
                    } else {
                        prompt('Copy this path (Ctrl+C) to open in Windows Explorer:', p);
                    }
                }
            }
        });
    }

    // Open Shortcuts Folder button
    const openShortcutsBtn = document.getElementById('openShortcutsBtn');
    if (openShortcutsBtn) {
        openShortcutsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const shortcutsPath = 'C:\\CSTApps';
            
            // Try to open directly with file protocol
            const url = 'file:///' + shortcutsPath.replace(/\\/g, '/');
            const w = window.open(url, '_blank');
            
            if (!w) {
                // Browser blocked it, show path for manual copy
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shortcutsPath).then(() => {
                        alert(`Shortcuts folder path copied to clipboard:\n${shortcutsPath}\n\nPaste into Windows Explorer (Win+E, Ctrl+V)`);
                    }).catch(() => {
                        prompt('Copy this path (Ctrl+C) to open in Windows Explorer:', shortcutsPath);
                    });
                } else {
                    prompt('Copy this path (Ctrl+C) to open in Windows Explorer:', shortcutsPath);
                }
            }
        });
    }

    // Server row click
    document.querySelectorAll('.server-row').forEach(row => {
        row.addEventListener('click', e => {
            if (e.target.type === 'checkbox') return;
            const cb = row.querySelector('.server-checkbox');
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change'));
        });
    });

    function updateServerRowStyles(){
        serverCheckboxes.forEach(cb=>{
            const row = cb.closest('.server-row');
            row.classList.toggle('selected', cb.checked);
        });
    }
    function updateSelectAllState(){
        const total = serverCheckboxes.length;
        const checked = Array.from(serverCheckboxes).filter(c=>c.checked).length;
        if (checked === 0){ selectAllServers.indeterminate=false; selectAllServers.checked=false; }
        else if (checked === total){ selectAllServers.indeterminate=false; selectAllServers.checked=true; }
        else { selectAllServers.indeterminate=true; selectAllServers.checked=false; }
    }
    function updateSelectedServersInfo(){
        selectedServers = Array.from(serverCheckboxes).filter(c=>c.checked).map(c=>c.value);
        if (selectedServers.length === 0) selectedServersInfo.textContent = 'No servers selected';
        else if (selectedServers.length === 1) selectedServersInfo.textContent = `Selected: ${selectedServers[0]}`;
        else selectedServersInfo.textContent = `Selected: ${selectedServers.length} servers`;
    }

    selectAllServers.addEventListener('change', ()=>{
        serverCheckboxes.forEach(c=>c.checked=selectAllServers.checked);
        updateServerRowStyles();
        updateSelectAllState();
        updateSelectedServersInfo();
    });
    serverCheckboxes.forEach(c=>c.addEventListener('change', ()=>{
        updateServerRowStyles();
        updateSelectAllState();
        updateSelectedServersInfo();
    }));
    updateServerRowStyles(); updateSelectAllState(); updateSelectedServersInfo();

    // Environment filtering for MSIX builds
    function filterMSIXBuilds() {
        const selectedEnvs = Array.from(document.querySelectorAll('input[name="SelectedEnvironments"]:checked')).map(e => e.value);
        console.log('filterMSIXBuilds called - Selected envs:', selectedEnvs);
        
        let hiddenCount = 0;
        let shownCount = 0;
        
        document.querySelectorAll('.build-row-msix').forEach(row => {
            const rowEnv = row.dataset.env;
            console.log('Row env:', rowEnv, 'Display:', row.style.display);
            // Only show builds if their environment is selected (case-insensitive match)
            const shouldShow = selectedEnvs.length > 0 && selectedEnvs.some(env => env.toLowerCase() === rowEnv?.toLowerCase());
            
            if (shouldShow) {
                row.style.display = 'flex'; // Use flex instead of empty string to force visibility
                row.classList.remove('d-none');
                shownCount++;
            } else {
                row.style.display = 'none';
                row.classList.add('d-none');
                hiddenCount++;
                // Uncheck if hidden
                const radio = row.querySelector('.msix-radio');
                if (radio && radio.checked) {
                    radio.checked = false;
                }
            }
        });
        
        console.log(`MSIX Builds - Shown: ${shownCount}, Hidden: ${hiddenCount}`);
        
        // Update MSIX card visibility - hide if no builds are shown
        const msixCard = document.querySelector('.card.shadow-sm.mb-3');
        if (msixCard && msixCard.querySelector('.card-header.bg-success')) {
            if (shownCount === 0) {
                msixCard.style.display = 'none';
            } else {
                msixCard.style.display = '';
            }
        }
        
        refreshSelectionSummary();
    }

    // Environment button changes
    document.querySelectorAll('input[name="SelectedEnvironments"]').forEach(envBtn => {
        envBtn.addEventListener('change', filterMSIXBuilds);
    });

    // Build selection helpers - now for radio buttons
    const buildRadios = document.querySelectorAll('.build-radio');
    const msixRadios = document.querySelectorAll('.msix-radio');

    function updateBuildRowStyles() {
        document.querySelectorAll('.build-radio').forEach(rb => {
            const row = rb.closest('.build-row');
            row?.classList.toggle('selected', rb.checked);
        });
        document.querySelectorAll('.msix-radio').forEach(rb => {
            const row = rb.closest('.build-row-msix');
            row?.classList.toggle('selected', rb.checked);
        });
    }
    
    function refreshSelectionSummary(){
        const standardRadio = document.querySelector('.build-radio:checked');
        const msixRadio = document.querySelector('.msix-radio:checked');
        
        selectionSummary.innerHTML='';
        
        if (standardRadio) {
            const div=document.createElement('div');
            const env = standardRadio.dataset.env ? ` (${standardRadio.dataset.env})` : '';
            div.textContent = `${standardRadio.dataset.app} :: ${standardRadio.dataset.build}${env}`;
            selectionSummary.appendChild(div);
        }
        
        if (msixRadio) {
            const div=document.createElement('div');
            const env = msixRadio.dataset.env ? ` (${msixRadio.dataset.env})` : '';
            div.innerHTML = `<span class="badge bg-success">MSIX</span> ${msixRadio.dataset.app} :: ${msixRadio.dataset.build}${env}`;
            selectionSummary.appendChild(div);
        }
        
        if (!standardRadio && !msixRadio) {
            selectionSummary.textContent='(none)';
        }
    }

    // Row click toggles for radio buttons
    document.querySelectorAll('.build-row').forEach(row=>{
        row.addEventListener('click', e=>{
            if (e.target.type === 'radio' || e.target.tagName === 'LABEL') return;
            const rb = row.querySelector('.build-radio');
            if (rb) {
                rb.checked = true;
                rb.dispatchEvent(new Event('change'));
            }
        });
    });

    document.querySelectorAll('.build-row-msix').forEach(row=>{
        row.addEventListener('click', e=>{
            if (e.target.type === 'radio' || e.target.tagName === 'LABEL') return;
            const rb = row.querySelector('.msix-radio');
            if (rb) {
                rb.checked = true;
                rb.dispatchEvent(new Event('change'));
            }
        });
    });

    // Build radio change handlers
    buildRadios.forEach(rb=>{
        rb.addEventListener('change', ()=>{
            updateBuildRowStyles();
            refreshSelectionSummary();
        });
    });

    msixRadios.forEach(rb=>{
        rb.addEventListener('change', ()=>{
            updateBuildRowStyles();
            refreshSelectionSummary();
        });
    });

    clearSelectionBtn.addEventListener('click', ()=>{
        document.querySelectorAll('.build-radio').forEach(r=>r.checked=false);
        document.querySelectorAll('.msix-radio').forEach(r=>r.checked=false);
        updateBuildRowStyles();
        refreshSelectionSummary();
    });

    // Initial filter
    filterMSIXBuilds();
    
    updateBuildRowStyles();
    refreshSelectionSummary();

    // SignalR
    const connection = new signalR.HubConnectionBuilder().withUrl("/DevApp/copyHub").build();
    connection.on("ReceiveProgress", p => {
        const bar = document.getElementById("progressBar");
        bar.style.width = p + "%";
        bar.textContent = p + "%";
    });
    connection.on("ReceiveMessage", m => {
        statusBox.textContent += m + "\n";
        statusBox.scrollTop = statusBox.scrollHeight;
    });
    connection.on("ReceiveError", m => {
        statusBox.textContent += "[ERROR] " + m + "\n";
        statusBox.scrollTop = statusBox.scrollHeight;
    });
    connection.start().then(()=> {
        document.getElementById('hubConnectionId').value = connection.connectionId;
    }).catch(err=>{
        console.error("SignalR connection error:", err);
        // alert('Real-time connection failed. Progress updates may be unavailable.');
    });

    // Deploy
    window.startCopy = function(){
        // alert('Deploy function called! Check console for details.');
        console.log('=== DEPLOY DEBUG START ===');
        console.log('startCopy function called');
        
        // Check for MSIX selection
        const msixRadio = document.querySelector('.msix-radio:checked');
        const standardRadio = document.querySelector('.build-radio:checked');
        
        if (msixRadio) {
            // MSIX installation - redirect to installation page
            const app = msixRadio.dataset.app;
            const build = msixRadio.dataset.build;
            const env = msixRadio.dataset.env;
            window.open(`/DevApp/Install?app=${encodeURIComponent(app)}&build=${encodeURIComponent(build)}&env=${encodeURIComponent(env)}`, '_blank');
            return;
        }
        
        const servers = Array.from(serverCheckboxes).filter(c=>c.checked).map(c=>c.value);
        
        if(!servers.length){ 
            alert('Select at least one server.'); 
            return; 
        }
        if(!standardRadio){ 
            alert('Select a build to deploy.'); 
            return; 
        }

        // Continue with the rest of the deployment logic...
        progressContainer.classList.remove('d-none');
        statusBox.textContent = '';
        deployBtn.disabled = true;

        const form = document.getElementById('deploymentForm');
        const fd = new FormData(form);
        
        console.log('Original form data:', Array.from(fd.entries()));
        
        fd.set('HubConnectionId', document.getElementById('hubConnectionId').value);
        fd.delete('Selections');
        fd.append('Selections', standardRadio.value);

        const token = fd.get('__RequestVerificationToken');
        const body = new URLSearchParams(fd).toString();
        
        console.log('Sending request to:', '/DevApp/Deploy?handler=Copy');
        console.log('Request body:', body);

        fetch('/DevApp/Deploy?handler=Copy', {
            method:'POST',
            headers:{
                'Content-Type':'application/x-www-form-urlencoded',
                'RequestVerificationToken': token
            },
            body
        }).then(async r=>{
            console.log('Response received:', r.status, r.statusText);
            const responseText = await r.text();
            console.log('Raw response text:', responseText);
            
            let payload;
            try { 
                payload = JSON.parse(responseText); 
            } catch(e) { 
                console.log('JSON parse error:', e);
                payload = null; 
            }
            
            // if (!r.ok || !payload || !payload.success) {
            //     const message = (payload && payload.message) ? payload.message : `HTTP ${r.status}`;
            //     alert(`Deployment failed: ${message}`);
            // } else {
            //     alert('Deployment succeeded!');
            // }
        }).catch(err=>{
            console.log('Fetch error:', err);
            // alert(`Network error: ${err.message}`);
        }).finally(()=>{
            deployBtn.disabled = false;
        });
    };

})();
</script>
}@* existing scripts remain below *@
